# Monitoring and Observability Guide

This guide covers the monitoring and observability features implemented in the Aircall Slack Agent service.

## Overview

The service now includes comprehensive monitoring and observability features:

- **Swagger/OpenAPI Documentation**: Interactive API documentation
- **Prometheus Metrics**: Detailed metrics collection
- **Structured Logging**: Winston-based logging with JSON format
- **Health Checks**: Service health monitoring
- **Performance Monitoring**: Request duration and throughput metrics

## Swagger Documentation

### Accessing the API Documentation

Once the service is running, you can access the interactive API documentation at:

```
http://localhost:3000/api-docs
```

### Features

- **Interactive Testing**: Test API endpoints directly from the browser
- **Request/Response Examples**: See example requests and responses
- **Authentication**: JWT Bearer token authentication support
- **Schema Validation**: Request/response schema documentation

### API Endpoints Documented

- **Health & Status**: `/health`, `/status`
- **Reports**: `/report/afternoon`, `/report/night`, `/report/custom`, `/report/today`
- **Scheduler**: `/scheduler/status`, `/scheduler/start`, `/scheduler/stop`, etc.
- **Monitoring**: `/metrics`

## Prometheus Metrics

### Metrics Endpoint

Access Prometheus metrics at:

```
http://localhost:3000/metrics
```

### Available Metrics

#### Default Metrics (Node.js)
- `process_cpu_seconds_total`: CPU usage
- `process_resident_memory_bytes`: Memory usage
- `nodejs_eventloop_lag_seconds`: Event loop lag
- `nodejs_gc_duration_seconds`: Garbage collection duration

#### Custom Application Metrics

**HTTP Request Metrics:**
- `http_request_duration_seconds`: Request duration histogram
- `http_requests_total`: Total request counter

**Business Logic Metrics:**
- `report_generation_duration_seconds`: Report generation time
- `report_generation_total`: Report generation counter
- `slack_messages_sent_total`: Slack message counter
- `aircall_api_calls_total`: Aircall API call counter
- `scheduler_runs_total`: Scheduler execution counter

### Metric Labels

Metrics include labels for detailed analysis:
- `method`: HTTP method (GET, POST, etc.)
- `route`: API endpoint path
- `status_code`: HTTP status code
- `report_type`: Type of report (afternoon, night, custom)
- `status`: Success/error status
- `endpoint`: Aircall API endpoint
- `service`: Service name (aircall-slack-agent)

## Logging

### Log Configuration

The service uses Winston for structured logging with the following configuration:

```javascript
{
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { service: 'api-server' },
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' }),
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    })
  ]
}
```

### Log Files

- `logs/error.log`: Error-level logs only
- `logs/combined.log`: All logs
- Console: Colored output for development

### Log Structure

Logs include:
- Timestamp
- Log level
- Service name
- Error stack traces (for errors)
- Request context (IP, user agent)
- Business operation details

## Health Checks

### Health Endpoint

```
GET /health
```

Returns basic service health status.

### Status Endpoint

```
GET /status
```

Returns detailed service status including:
- Service mode
- Configuration summary
- Available endpoints
- Excluded users

## Monitoring Setup

### 1. Prometheus Configuration

Add this to your `prometheus.yml`:

```yaml
scrape_configs:
  - job_name: 'aircall-slack-agent'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/metrics'
    scrape_interval: 15s
```

### 2. Grafana Dashboard

Create a Grafana dashboard with the following panels:

**System Metrics:**
- CPU Usage
- Memory Usage
- Event Loop Lag

**Application Metrics:**
- Request Rate (requests/second)
- Request Duration (95th percentile)
- Error Rate
- Report Generation Success Rate
- Slack Message Success Rate

**Business Metrics:**
- Reports Generated by Type
- Aircall API Call Success Rate
- Scheduler Execution Status

### 3. Alerting Rules

Example Prometheus alerting rules:

```yaml
groups:
  - name: aircall-slack-agent
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status_code=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"
          
      - alert: ServiceDown
        expr: up{job="aircall-slack-agent"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service is down"
```

## Observability Best Practices

### 1. Distributed Tracing

Consider adding distributed tracing with tools like:
- **Jaeger**: For request tracing
- **Zipkin**: Alternative tracing solution
- **OpenTelemetry**: Standard observability framework

### 2. Application Performance Monitoring (APM)

Consider integrating APM tools:
- **New Relic**: Full-stack observability
- **DataDog**: Monitoring and analytics
- **Sentry**: Error tracking and performance monitoring

### 3. Log Aggregation

For production environments, consider:
- **ELK Stack**: Elasticsearch, Logstash, Kibana
- **Fluentd**: Log collection and forwarding
- **Splunk**: Log management and analytics

### 4. Infrastructure Monitoring

Monitor the underlying infrastructure:
- **Node Exporter**: System metrics
- **cAdvisor**: Container metrics (if using Docker)
- **Blackbox Exporter**: External service monitoring

## Performance Monitoring

### Key Performance Indicators (KPIs)

1. **Response Time**: Target < 2 seconds for 95th percentile
2. **Throughput**: Requests per second
3. **Error Rate**: < 1% error rate
4. **Availability**: 99.9% uptime
5. **Report Generation Time**: < 30 seconds

### Monitoring Dashboards

Create dashboards for:
- **Real-time Monitoring**: Current system status
- **Historical Analysis**: Trend analysis
- **Business Metrics**: Report generation success rates
- **Infrastructure**: Resource utilization

## Troubleshooting

### Common Issues

1. **High Memory Usage**
   - Check for memory leaks
   - Monitor garbage collection metrics
   - Review log file sizes

2. **Slow Response Times**
   - Check Aircall API response times
   - Monitor database connection pool
   - Review external service dependencies

3. **High Error Rates**
   - Check Aircall API availability
   - Verify Slack API credentials
   - Review authentication configuration

### Debug Endpoints

- `/debug/activity-data`: Raw activity data inspection
- `/status`: Service configuration and status
- `/health`: Basic health check

## Security Considerations

### Metrics Security

- Metrics endpoint should be protected in production
- Consider using authentication for metrics access
- Use network-level access controls

### Log Security

- Avoid logging sensitive data (API keys, tokens)
- Implement log rotation and retention policies
- Use secure log transmission in production

### API Security

- JWT authentication is required for most endpoints
- Rate limiting is implemented
- CORS is configured for localhost only

## Future Enhancements

### Planned Monitoring Features

1. **Custom Business Metrics**
   - User activity patterns
   - Report delivery success rates
   - Integration health status

2. **Advanced Alerting**
   - Anomaly detection
   - Predictive alerting
   - Escalation policies

3. **Performance Optimization**
   - Database query monitoring
   - Cache hit rates
   - External API performance tracking

4. **User Experience Monitoring**
   - API response time percentiles
   - Error categorization
   - Usage analytics 